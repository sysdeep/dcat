# BinMap

хранение данных в бинарном формате

данные файлов хранятся в 1 таблице, а текстовые данные. - во второй

это необходимо для быстрого чтения заголовков

для адресации - создавать карту при загрузке - 
отсутствие жёсткой адресации позволит произвольно менять данные в памяти и сохранять 
их в произвольном порядке - что удобно при удалении. 
При загрузке создастся новая карта 



при открытии файла 
- читаем заголовок, загружаем его
- узнаём расположение и размер секции данных
- загружаем секцию данных в память
- распарсиваем секцию данных

- узнаём расположение и размер секции текста
- загружаем секцию текста в память



текстовая секция представляет из себя кучу, в которой находятся бинарные строки. 
На каждую запись в куче есть ссылка в структуре данных файла.


 


```xml

<file>
	<file_header />
	<volume_header />
	<records>
		<record />
	</records>
	<heap>
		<bin_string />
	</heap>
</file>


```

## file_header

Заголовок файла

- magic 			[ushort 2]	- магическая константа(0xfafb)
- version 			[ushort 2]	- версия структуры файла
--- header_size		[ushort 2]	- размер заголовка(volume_header)


## volume_header

Запись заголовка тома

- created	(8)				- дата создания(unix timestamp)
- icon		(2)				- icon_id
- records	(8)				- кол-во записей в базе
- table_len	(8)				- длина секции табличных данных
- heap_len	(8)				- длина секции кучи
- name			(cstring)	- название тома
- scan_path		(cstring)	- путь сканирования
- description	(cstring)	- произвольное описание

Рассмотреть возможность хранения текстовых данных в куче

Возможность рассмотрена и реализованна в промотрщике и конверторе

Приемущества:
- стандартный размер заголовка(проще читать)
- проще кодировать строки

Недостатки:
- для получения текстовых данных, необходимо обратится к куче


- npos			[uint 4] 	- позиция названия в куче
- nsize			[ushort 2] 	- размер названия в куче
- ppos			[uint 4] 	- позиция пути сканирования в куче
- psize			[ushort 2] 	- размер пути сканирования в куче
- dpos			[uint 4] 	- позиция описания в куче
- dsize			[ushort 2] 	- размер описания в куче






## records

Область хранения таблицы с файловыми записями. Содержит в себе объекты record. 
Размер её вычисляем, исходя из кол-ва записей и длины записи(константа) 

## record

Запись файлового объекта

- type 			[ushort 2]	- тип файла(каталог - 0/файл - 1)
- size 			[ulong 8]	- размер записи
- ctime 		[ulong 8]	- дата создания файла(unix timestamp)
- rights 		[ushort 2]	- код доступа(unix 777)
- fid 			[uint 4]	- id записи
- pid 			[uint 4]	- id родителя(0 - корень)
- npos			[uint 4] 	- позиция названия в куче
- nsize			[ushort 2] 	- размер названия в куче
- dpos			[uint 4] 	- позиция описания в куче
- dsize			[ushort 2] 	- размер описания в куче

длина - 40b



## heap

Область кучи, содержит последовательный набор текстовых данных в бинарном виде. 
Кажды объект располагается непосредственно один за другим, без какого либо разделителя.

Для получения данных из кучи, необходимо указать позицию объекта и его длину.

Каждый текстовый объект представлен в бинарном виде, преобразованный из кодировки UTF-8 









------

|id|pid|...data...|



on load - читаем все записи(они одной длины, потому можно читать только необходимые данны) и строим карту

|id|pid|pos|



Плюсы:

- возможность удаления


Минусы:
- создание карты при загрузке



## Запись

- сформировать секцию статичных данных и динамических данных в памяти
- сформировать заголовок
- записать данные в файл 



## Сохранение изменений


- секция данных преобразуется в бинарный вид
- секция текста копируется в новую бинарную секцию(с применением изменений)
- пред. 2 операции должны бвть одновременными(для взаимной корректировки данных)
- формируется заголовок
- запись в файл




## Чтение

распаковываем таблицу файлов, они все сразу готовы

текстовые данные остаются в куче

при запросе определённых нод, они выбираются из готовых записей файлов, 
и дополняются текстовыми данными из кучи.

тем самым сводится к минимуму время доступа.








## Результаты

^ кол-во файлов ^ размер базы 	^ время распарсивания данных ^
| 313057	 	| 2.6 Mb 		| 0.8 с 					 |








